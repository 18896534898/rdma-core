
Name: srptools
Version: @VERSION@
Release: 1%{?dist}
Summary: Tools for SRP/IB

Group: Applications/System
License: GPL/BSD
Url: http://www.openfabrics.org/
Source: http://www.openfabrics.org/downloads/%{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

%description
In conjunction with the kernel ib_srp driver, srptools allows you to
discover and use SCSI devices via the SCSI RDMA Protocol over InfiniBand.

%prep
rm -rf $RPM_BUILD_ROOT
%setup -q -n %{name}-%{version}

%build
%configure
make %{?_smp_mflags}

%install
make DESTDIR=%{buildroot} install

%clean
rm -rf $RPM_BUILD_ROOT

%post
if [ $1 = 1 ]; then # 1 : This package is being installed for the first time
    for ib_conf_file in /etc/infiniband/openib.conf /etc/rdma/rdma.conf; do
	if [ -e $ib_conf_file ] &&
	    ! grep -q '^SRPHA_ENABLE=' $ib_conf_file; then
	    cat <<EOF >>$ib_conf_file

# Enable SRP High Availability daemon
SRPHA_ENABLE=no
SRP_DAEMON_ENABLE=no
EOF
	fi
    done
    if [ -e /sbin/chkconfig ]; then
        /sbin/chkconfig --add srpd
    elif [ -e /usr/sbin/update-rc.d ]; then
        /usr/sbin/update-rc.d srpd defaults
    else
        /usr/lib/lsb/install_initd /etc/init.d/srpd
    fi
fi
if type systemctl >/dev/null 2>&1; then
    systemctl --system daemon-reload
fi
if [ $1 != 1 ]; then
    /etc/init.d/srpd condrestart
fi

%preun
if [ $1 = 0 ]; then
    /etc/init.d/srpd stop
    if [ -e /sbin/chkconfig ]; then
        /sbin/chkconfig --del srpd
    elif [ -e /usr/sbin/update-rc.d ]; then
        /usr/sbin/update-rc.d -f srpd remove
    else
        /usr/lib/lsb/remove_initd /etc/init.d/srpd
    fi
fi

%files
%defattr(-,root,root)
%config(noreplace) /etc/srp_daemon.conf
%config(noreplace) %{_sysconfdir}/logrotate.d/srp_daemon
%config(noreplace) %{_sysconfdir}/rsyslog.d/srp_daemon.conf
%{_sysconfdir}/init.d/srpd
%{_sbindir}/ibsrpdm
%{_sbindir}/srp_daemon
%{_sbindir}/srp_daemon.sh
%{_mandir}/man1/ibsrpdm.1*
%{_mandir}/man1/srp_daemon.1*
%doc README NEWS ChangeLog COPYING

%changelog
* Wed Aug 22 2007 Vladimir Sokolovsky <vlad@mellanox.co.il>
- Added srp_daemon.conf
* Tue Sep  5 2006 Vladimir Sokolovsky <vlad@mellanox.co.il>
- Added srp_daemon and scripts to execute this daemon
* Tue Mar 21 2006 Roland Dreier <rdreier@cisco.com> - 0.0.4-1
- Initial attempt at a working spec file
